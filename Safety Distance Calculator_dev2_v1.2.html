<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANSI B11.19 Safety Distance Calculator</title>
    <style>
        :root {
            --rivian-blue: #00A1E0;
            --dark-grey: #333;
            --light-grey: #f4f4f4;
            --white: #ffffff;
            --border-color: #ddd;
            --header-bg: #f8f9fa;
            --highlight-bg: #e6f7ff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #eef2f5;
            color: var(--dark-grey);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Main Layout */
        .container {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 20px;
            border-bottom: 2px solid var(--rivian-blue);
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: end;
        }

        h1 { margin: 0; color: var(--dark-grey); font-size: 1.8rem; }
        h2 { font-size: 1.1rem; margin-top: 0; color: #555; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 15px;}
        p.subtitle { margin: 5px 0 0; color: #666; font-size: 0.9rem; }

        .print-btn {
            background-color: #fff;
            border: 1px solid var(--rivian-blue);
            color: var(--rivian-blue);
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .print-btn:hover { background-color: var(--rivian-blue); color: white; }

        /* Calculator Sections */
        .calc-section {
            background: var(--white);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .doc-header {
            border-left: 4px solid var(--rivian-blue);
        }

        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }

        .input-wrapper {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: #444;
        }

        input, select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.95rem;
            box-sizing: border-box;
            background-color: #fff;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--rivian-blue);
            box-shadow: 0 0 0 2px rgba(0,161,224,0.2);
        }

        /* Help Tooltips */
        .help-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #999;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 11px;
            cursor: help;
            margin-left: 5px;
        }

        .help-text {
            display: none;
            font-size: 0.85rem;
            color: #666;
            background: #fff;
            border-left: 3px solid var(--rivian-blue);
            padding: 5px 10px;
            margin-top: 5px;
        }

        /* Results Box */
        .result-box {
            background: var(--dark-grey);
            color: var(--white);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            page-break-inside: avoid;
        }

        .result-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--rivian-blue);
        }

        .result-equation {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            color: #bbb;
            margin-top: 10px;
        }

        /* Side Panel (Reference Guide) */
        .side-panel {
            width: 650px;
            background: var(--white);
            border-left: 1px solid var(--border-color);
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            right: -670px;
            top: 0;
            bottom: 0;
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .side-panel.open {
            right: 0;
        }

        .panel-header {
            padding: 20px;
            background: var(--rivian-blue);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .panel-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .panel-trigger {
            position: fixed;
            right: 20px;
            top: 20px;
            background: var(--rivian-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 900;
            font-weight: bold;
        }

        /* Tables in Panel */
        .ref-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            margin-bottom: 15px;
        }
        .ref-table th, .ref-table td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: center;
        }
        .ref-table th { background-color: var(--header-bg); font-weight: 600;}
        .ref-table td:first-child { background-color: var(--header-bg); font-weight: 600; text-align: left;}

        .table-scroll {
            overflow-x: auto;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }
        
        .i3-table, .e3-table {
            min-width: 100%;
            font-size: 0.75rem;
        }
        
        .i3-table th, .e3-table th {
            background-color: #e0e0e0;
            vertical-align: middle;
        }
        .i3-table tr:nth-child(even), .e3-table tr:nth-child(even) { background-color: #f9f9f9; }
        .e3-table td { vertical-align: middle; }
        
        /* Table E.3 visual cues */
        .red-line-top { border-top: 2px solid red !important; }
        .red-line-bottom { border-bottom: 2px solid red !important; }
        .red-line-right { border-right: 2px solid red !important; }

        .pref-value-box {
            background-color: #eef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid var(--rivian-blue);
        }

        /* Utility */
        .hidden { display: none; }
        .unit-label { position: absolute; right: 10px; top: 35px; color: #888; font-size: 0.8rem;}
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0;}

        /* PRINT STYLES */
        @media print {
            body { background-color: white; height: auto; overflow: visible; font-size: 12pt; }
            .container { margin: 0; padding: 0; max-width: 100%; width: 100%; }
            .side-panel, .panel-trigger, .help-icon, .help-text, .print-btn { display: none !important; }
            .calc-section { box-shadow: none; border: 1px solid #ccc; page-break-inside: avoid; margin-bottom: 15px; }
            .doc-header { border: 1px solid #000; border-left: 5px solid #000; }
            header { border-bottom: 2px solid #000; margin-bottom: 10px; }
            h1 { font-size: 1.4rem; }
            h2 { font-size: 1rem; border-bottom: 1px solid #000; color: #000; }
            
            /* Clean up inputs for print */
            input, select { 
                border: none; 
                border-bottom: 1px solid #ccc; 
                padding: 0; 
                background: none; 
                font-family: inherit;
                color: #000;
                appearance: none;
                -webkit-appearance: none;
            }
            .input-wrapper label { font-size: 0.8rem; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
            
            /* Result Box for Print */
            .result-box { 
                background-color: #fff !important; 
                color: #000 !important; 
                border: 2px solid #000; 
                -webkit-print-color-adjust: exact; 
                padding: 10px;
            }
            .result-value { color: #000 !important; font-size: 2rem; }
            .result-equation { color: #333 !important; }
            
            /* Hide Unit Selector in print */
            #unitSelectWrapper { display: none; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div>
                <h1>Safety Distance Calculator</h1>
                <p class="subtitle">ANSI B11.19-2019 (R2024) | Section 9.6, Annex H, Annex I</p>
            </div>
            <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print / Save PDF</button>
        </header>

        <form id="safetyForm">
            
            <div class="calc-section doc-header">
                <h2>Documentation Reference</h2>
                <div class="input-group">
                    <div class="input-wrapper">
                        <label>Line / Area / Cell</label>
                        <input type="text" placeholder="e.g. Body Shop / Cell 10">
                    </div>
                    <div class="input-wrapper">
                        <label>Asset / Machine ID</label>
                        <input type="text" placeholder="e.g. R1-1234">
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-wrapper">
                        <label>Safeguarding Device Name / Tag</label>
                        <input type="text" placeholder="e.g. LC-01 (Light Curtain)">
                    </div>
                    <div class="input-wrapper">
                        <label>Identified Hazard</label>
                        <input type="text" placeholder="e.g. Pinch Point / Robot Motion">
                    </div>
                </div>
            </div>

            <div class="calc-section">
                <div class="input-group">
                    <div class="input-wrapper" id="unitSelectWrapper">
                        <label>Measurement Unit</label>
                        <select id="units" onchange="updateUnits()">
                            <option value="mm">Metric (mm, m/s)</option>
                            <option value="in">Imperial (inches, in/s)</option>
                        </select>
                    </div>
                    <div class="input-wrapper">
                        <label>Approach Speed (K) <span class="help-icon" title="Speed of body movement">?</span></label>
                        <input type="number" id="K" value="1600" step="1">
                        <span class="unit-label" id="unit-speed">mm/s</span>
                        <div class="help-text">Standard: 1600 mm/s (63 in/s). See Reference Guide Annex H.3.</div>
                    </div>
                </div>
            </div>

            <div class="calc-section">
                <h2>Total Stopping Time (T) <small style="font-weight:normal; font-size:0.8rem">(See Annex H.4)</small></h2>
                <p style="font-size:0.8rem; color:#666;">Enter all times in milliseconds (ms).</p>
                
                <div class="input-group">
                    <div class="input-wrapper">
                        <label>Device Reaction (Td)</label>
                        <input type="number" id="Td" value="100" placeholder="e.g. Light curtain time">
                        <div class="help-text">Max reaction time stated by the supplier. Preferred default: 100ms.</div>
                    </div>
                    <div class="input-wrapper">
                        <label>Interface Reaction (Ti)</label>
                        <input type="number" id="Ti" value="20" placeholder="e.g. Safety relay">
                        <div class="help-text">Delay of interface between device and control system. Preferred default: 20ms.</div>
                    </div>
                    <div class="input-wrapper">
                        <label>Control System (Tc)</label>
                        <input type="number" id="Tc" value="0.05" placeholder="e.g. PLC scan time">
                        <div class="help-text">Delay from inputs to logic initiation. Preferred default: 0.05ms.</div>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-wrapper">
                        <label>Machine Stop Time (Ts)</label>
                        <input type="number" id="Ts" value="0" placeholder="Measured Stop Time">
                        <div class="help-text">Worst case time for hazardous motion to cease after actuator is de-energized. Measured via stop-time analysis.</div>
                    </div>
                    <div class="input-wrapper">
                        <label>Monitor Factor (Tscm)</label>
                        <input type="number" id="Tscm" value="0" placeholder="Brake monitor margin">
                        <div class="help-text">Time added by safe condition/brake monitoring systems (degradation margin).</div>
                    </div>
                </div>
                <div style="text-align: right; font-weight: bold; color: var(--rivian-blue);">
                    Total Time (T): <span id="totalTimeDisplay">0</span> ms
                </div>
            </div>

            <div class="calc-section">
                <h2>Device Configuration & Reach (d<sub>ds</sub>) <small style="font-weight:normal; font-size:0.8rem">(See Annex I)</small></h2>
                
                <div class="input-wrapper" style="margin-bottom: 20px;">
                    <label>Select Engineering Control (Device Type)</label>
                    <select id="deviceType" onchange="updateDeviceInputs()">
                        <option value="vertical">Vertical Presence Sensing (e.g., Light Curtain)</option>
                        <option value="horizontal">Horizontal Presence Sensing (e.g., Area Scanner)</option>
                        <option value="twohand">Two-Hand Control</option>
                        <option value="single">Single Actuating Control (Hand/Foot)</option>
                        <option value="mat">Safety Mat</option>
                        <option value="rf">RF / Capacitance Device</option>
                        <option value="interlock">Interlocked Guard (Reaching Through)</option>
                    </select>
                </div>

                <div id="dynamicInputs" class="input-group">
                    </div>
            </div>

            <div class="calc-section">
                <h2>Supplemental Distance (Z) <small style="font-weight:normal; font-size:0.8rem">(See Annex H.6)</small></h2>
                <div class="input-group">
                    <div class="input-wrapper">
                        <label>Measurement Error (Zm)</label>
                        <input type="number" id="Zm" value="0">
                        <span class="unit-label" class="unit-dist">mm</span>
                    </div>
                    <div class="input-wrapper">
                        <label>Other Factors (Zr, Zf, Zb)</label>
                        <input type="number" id="Zother" value="0">
                        <span class="unit-label" class="unit-dist">mm</span>
                        <div class="help-text">Reflection errors, lack of ground clearance, brake wear factors.</div>
                    </div>
                </div>
            </div>

            <div class="result-box">
                <label style="color: #bbb;">Minimum Safety Distance (D)</label>
                <div class="result-value" id="finalResult">0 mm</div>
                <div class="result-equation" id="equationDisplay">D = (K x T) + dds + Z</div>
            </div>

        </form>
    </div>

    <button class="panel-trigger" onclick="togglePanel()">? Reference Guide</button>

    <div class="side-panel" id="sidePanel">
        <div class="panel-header">
            <h3>Reference Guide (ANSI B11.19)</h3>
            <button class="close-btn" onclick="togglePanel()">&times;</button>
        </div>
        <div class="panel-content">
            
            <h4>1. The Core Formula (Annex H)</h4>
            <p><strong>D = (K √ó T) + d<sub>ds</sub> + Z</strong></p>
            <ul>
                <li><strong>K:</strong> Approach Speed (Usually 1.6 m/s or 63 in/s). See Annex H.3.</li>
                <li><strong>T:</strong> Total Stopping Time (See section 2 below).</li>
                <li><strong>d<sub>ds</sub>:</strong> Reach Distance (Depth Penetration). Depends on device type (Annex I).</li>
                <li><strong>Z:</strong> Supplemental factors (Measurement error, brake wear, etc.). See Annex H.6.</li>
            </ul>

            <hr>

            <h4>2. Total Stopping Time (T)</h4>
            <p><em>Annex H.4</em></p>
            <p><strong>T = Td + Ti + Tc + Ts + Tscm</strong></p>
            <ul>
                <li><strong>Td (Device):</strong> Reaction time of the device (e.g. Light Curtain, Scanner). <em>Source: Supplier Specification.</em></li>
                <li><strong>Ti (Interface):</strong> Reaction time of the safety interface (e.g. Safety Relay, Safety PLC Input card). <em>Source: Component Datasheet.</em></li>
                <li><strong>Tc (Control):</strong> Reaction time of the control system (e.g. Logic processing time, Scan time). <em>Source: System Design/Config.</em></li>
                <li><strong>Ts (Machine):</strong> Physical stop time of the machine (Braking time). <em>Source: Stop-time Measurement (Annex J).</em></li>
                <li><strong>Tscm (Monitor):</strong> Safety factor for degradation of braking system (e.g. 10-20% margin).</li>
            </ul>
            
            <div class="pref-value-box">
                <strong>Preferred Values:</strong><br>
                Td = 100 ms<br>
                Ti = 20 ms<br>
                Tc = 0.05 ms
            </div>

            <hr>

            <h4>3. Vertical Sensing Fields (Table I.3)</h4>
            <p><em>Reach Through (d<sub>dt</sub>):</em> Based on detection capability (d<sub>e</sub>).</p>
            <ul>
                <li>If d<sub>e</sub> ‚â§ 64mm (2.5"): <br> <code>d<sub>dt</sub> = 3.4 √ó (d_e - 7mm)</code></li>
                <li>If 64mm < d<sub>e</sub> ‚â§ 600mm: <br> <code>d<sub>dt</sub> = 850mm (33.5")</code></li>
            </ul>
            
            <p><em>Reach Over (d<sub>do</sub>):</em> <strong>Table I.3</strong></p>
            <div class="table-scroll">
                <table class="ref-table i3-table">
                    <thead>
                        <tr>
                            <th rowspan="2" style="width: 15%">Height of Hazard (Hh)</th>
                            <th colspan="12">Height of upper edge of sensing field (Hdt)</th>
                        </tr>
                        <tr>
                            <th>900</th><th>1000</th><th>1100</th><th>1200</th><th>1300</th><th>1400</th><th>1600</th><th>1800</th><th>2000</th><th>2200</th><th>2400</th><th>2600</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>2600</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
                        <tr><td>2500</td><td>400</td><td>400</td><td>350</td><td>300</td><td>300</td><td>300</td><td>300</td><td>300</td><td>250</td><td>150</td><td>100</td><td>0</td></tr>
                        <tr><td>2400</td><td>550</td><td>550</td><td>550</td><td>500</td><td>450</td><td>450</td><td>400</td><td>400</td><td>300</td><td>250</td><td>100</td><td>0</td></tr>
                        <tr><td>2200</td><td>800</td><td>750</td><td>750</td><td>700</td><td>650</td><td>650</td><td>600</td><td>550</td><td>400</td><td>250</td><td>0</td><td>0</td></tr>
                        <tr><td>2000</td><td>950</td><td>950</td><td>850</td><td>850</td><td>800</td><td>750</td><td>700</td><td>550</td><td>400</td><td>0</td><td>0</td><td>0</td></tr>
                        <tr><td>1800</td><td>1100</td><td>1100</td><td>950</td><td>950</td><td>850</td><td>800</td><td>750</td><td>550</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
                        <tr><td>1600</td><td>1150</td><td>1150</td><td>1100</td><td>1000</td><td>900</td><td>850</td><td>750</td><td>450</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
                        <tr><td>1400</td><td>1200</td><td>1200</td><td>1100</td><td>1000</td><td>900</td><td>850</td><td>650</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
                        <tr><td>1200</td><td>1200</td><td>1200</td><td>1100</td><td>1000</td><td>850</td><td>800</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
                        <tr><td>1000</td><td>1200</td><td>1150</td><td>1050</td><td>950</td><td>750</td><td>700</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
                        <tr><td>800</td><td>1150</td><td>1050</td><td>950</td><td>800</td><td>500</td><td>450</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
                        <tr><td>600</td><td>1050</td><td>950</td><td>750</td><td>550</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
                        <tr><td>400</td><td>900</td><td>700</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
                        <tr><td>200</td><td>600</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
                        <tr><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
                    </tbody>
                </table>
            </div>
            <p style="font-size:0.75rem; color:#666;">(Dimensions in mm)</p>

            <hr>

            <h4>4. Reaching Through Guards (Table E.3)</h4>
            <p><em>Annex E</em></p>
            <div class="table-scroll">
                <table class="ref-table e3-table">
                    <thead>
                        <tr>
                            <th>Part of body</th>
                            <th>Opening Size (e) <br>(mm)</th>
                            <th>Slot <br>(mm)</th>
                            <th>Square <br>(mm)</th>
                            <th>Round <br>(mm)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td rowspan="2">Fingertip</td>
                            <td>0 < e ‚â§ 4</td>
                            <td>‚â• 2</td>
                            <td>‚â• 2</td>
                            <td>‚â• 2</td>
                        </tr>
                        <tr>
                            <td>4 < e ‚â§ 6</td>
                            <td>‚â• 10</td>
                            <td>‚â• 5</td>
                            <td>‚â• 5</td>
                        </tr>
                        <tr>
                            <td rowspan="2">Finger up to knuckle</td>
                            <td>6 < e ‚â§ 8</td>
                            <td>‚â• 20</td>
                            <td>‚â• 15</td>
                            <td>‚â• 5</td>
                        </tr>
                        <tr>
                            <td class="red-line-bottom">8 < e ‚â§ 10</td>
                            <td class="red-line-bottom">‚â• 80</td>
                            <td class="red-line-bottom">‚â• 25</td>
                            <td class="red-line-bottom">‚â• 20</td>
                        </tr>
                        <tr>
                            <td rowspan="3">Hand</td>
                            <td>10 < e ‚â§ 12</td>
                            <td class="red-line-right">‚â• 100</td>
                            <td>‚â• 80</td>
                            <td>‚â• 80</td>
                        </tr>
                        <tr>
                            <td>12 < e ‚â§ 20</td>
                            <td class="red-line-right">‚â• 120</td>
                            <td>‚â• 120</td>
                            <td>‚â• 120</td>
                        </tr>
                        <tr>
                            <td class="red-line-bottom">20 < e ‚â§ 30</td>
                            <td class="red-line-right red-line-bottom">‚â• 850</td>
                            <td class="red-line-bottom">‚â• 120</td>
                            <td class="red-line-bottom">‚â• 120</td>
                        </tr>
                        <tr>
                            <td rowspan="2">Arm up to shoulder</td>
                            <td>30 < e ‚â§ 40</td>
                            <td class="red-line-right">‚â• 850</td>
                            <td class="red-line-bottom">‚â• 200</td>
                            <td class="red-line-bottom">‚â• 120</td>
                        </tr>
                        <tr>
                            <td>40 < e ‚â§ 120</td>
                            <td class="red-line-right">‚â• 850</td>
                            <td>‚â• 850</td>
                            <td>‚â• 850</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p style="font-size:0.75rem; color:#666;">
                <strong>Red lines indicate restriction boundaries based on body part size.</strong><br>
                a: If slot length ‚â§ 65mm, thumb acts as stop and reach distance reduces to 200mm.
            </p>
            
            <hr>
            
            <div style="background-color:#eef; padding:10px; border-radius:4px;">
                <strong>Note on Units:</strong><br>
                ANSI B11.19 uses metric (mm) as primary. 
                1 inch = 25.4 mm.<br>
                1.6 m/s = 1600 mm/s ‚âà 63 in/s.
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & Constants ---
        const K_DEFAULT_MM = 1600;
        const K_DEFAULT_IN = 63;
        let currentUnit = 'mm';

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            updateUnits(); // Set initial placeholders
            updateDeviceInputs(); // Render default device inputs
            
            // Add listeners to static inputs
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', calculateSafetyDistance);
                input.addEventListener('change', calculateSafetyDistance);
            });

            // Help Text Toggle
            document.querySelectorAll('.help-icon').forEach(icon => {
                icon.addEventListener('click', (e) => {
                    const wrapper = e.target.closest('.input-wrapper');
                    const text = wrapper.querySelector('.help-text');
                    if(text) text.style.display = text.style.display === 'block' ? 'none' : 'block';
                });
            });
        });

        // --- Dynamic Input Generation (Annex I Selector) ---
        function updateDeviceInputs() {
            const type = document.getElementById('deviceType').value;
            const container = document.getElementById('dynamicInputs');
            container.innerHTML = ''; // Clear

            let html = '';

            if (type === 'vertical') {
                html += `
                    <div class="input-wrapper">
                        <label>Effective Detection Capability (d<sub>e</sub>)</label>
                        <input type="number" id="de" value="14" step="1">
                        <span class="unit-label unit-dist">mm</span>
                        <div class="help-text">Often called resolution. Standard finger: 14mm, Hand: 30mm. (Annex I.3.2)</div>
                    </div>
                    <div class="input-wrapper">
                        <label>Is Reach Over Possible?</label>
                        <select id="reachOver" onchange="calculateSafetyDistance()">
                            <option value="no">No (High Guard)</option>
                            <option value="yes">Yes (Use Table I.3)</option>
                        </select>
                        <div class="help-text">If the top beam is low enough to reach over, enter the Table I.3 value below.</div>
                    </div>
                    <div class="input-wrapper hidden" id="manualReachOverDiv">
                        <label>Reach Over Distance (Table I.3)</label>
                        <input type="number" id="manualReachOver" value="0">
                        <span class="unit-label unit-dist">mm</span>
                        <div class="help-text">Use Reference Guide > Table I.3 to find this value based on height.</div>
                    </div>
                `;
            } else if (type === 'horizontal') {
                html += `
                    <div class="input-wrapper">
                        <label>Height of Plane (H)</label>
                        <input type="number" id="Hs" value="300">
                        <span class="unit-label unit-dist">mm</span>
                        <div class="help-text">Max 1000mm. Typically 300mm or less to prevent crawling under. (Annex I.4.2)</div>
                    </div>
                    <div class="input-wrapper">
                        <label>Reach Distance (Standard)</label>
                        <input type="number" id="dds_manual" value="${currentUnit === 'mm' ? 1200 : 48}" readonly style="background:#f4f4f4">
                        <span class="unit-label unit-dist">${currentUnit}</span>
                        <div class="help-text">Standard horizontal reach over distance is 1200mm (48"). (Annex I.4.1)</div>
                    </div>
                `;
            } else if (type === 'twohand') {
                html += `
                    <div class="input-wrapper">
                        <label>Are controls shrouded?</label>
                        <select id="shrouded" onchange="calculateSafetyDistance()">
                            <option value="no">No</option>
                            <option value="yes">Yes (Restricted)</option>
                        </select>
                        <div class="help-text">If controls are shrouded to prevent hand encroachment, distance can be 0. Otherwise 550mm. (Annex I.6)</div>
                    </div>
                `;
            } else if (type === 'single') {
                html += `
                    <div class="input-wrapper">
                        <label>Actuator Type</label>
                        <select id="actuatorType" onchange="calculateSafetyDistance()">
                            <option value="hand">Hand Operated</option>
                            <option value="foot">Foot Operated</option>
                        </select>
                        <div class="help-text">Hand: 2200mm (87"), Foot: 2500mm (98.5"). (Annex I.7)</div>
                    </div>
                `;
            } else if (type === 'mat') {
                html += `
                    <div class="input-wrapper">
                        <label>Reach Distance</label>
                        <input type="number" id="dds_manual" value="${currentUnit === 'mm' ? 1200 : 48}" readonly style="background:#f4f4f4">
                        <span class="unit-label unit-dist">${currentUnit}</span>
                        <div class="help-text">Standard reach over distance is typically 1200mm.</div>
                    </div>
                `;
            } else if (type === 'interlock') {
                html += `
                    <div class="input-wrapper">
                        <label>Guard Opening Size (e)</label>
                        <input type="number" id="gapSize" value="0">
                        <span class="unit-label unit-dist">${currentUnit}</span>
                        <div class="help-text">Width of slot, square, or diameter of round opening.</div>
                    </div>
                    <div class="input-wrapper">
                        <label>Manual Reach Distance (Table E.3)</label>
                        <input type="number" id="manualReachThrough" value="0">
                        <span class="unit-label unit-dist">${currentUnit}</span>
                        <div class="help-text">Look up value in Reference Guide > Table E.3 based on gap size.</div>
                    </div>
                `;
            }

            container.innerHTML = html;
            
            // Re-attach listeners to new inputs
            const inputs = container.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', calculateSafetyDistance);
                input.addEventListener('change', calculateSafetyDistance);
            });

            calculateSafetyDistance();
        }

        // --- Core Logic ---
        function calculateSafetyDistance() {
            // 1. Get Base Values
            const K = parseFloat(document.getElementById('K').value) || 0;
            
            const Td = parseFloat(document.getElementById('Td').value) || 0;
            const Ti = parseFloat(document.getElementById('Ti').value) || 0;
            const Tc = parseFloat(document.getElementById('Tc').value) || 0;
            const Ts = parseFloat(document.getElementById('Ts').value) || 0;
            const Tscm = parseFloat(document.getElementById('Tscm').value) || 0;
            const T_total = (Td + Ti + Tc + Ts + Tscm) / 1000; // Convert ms to seconds

            document.getElementById('totalTimeDisplay').innerText = (T_total * 1000).toFixed(2);

            const Zm = parseFloat(document.getElementById('Zm').value) || 0;
            const Zother = parseFloat(document.getElementById('Zother').value) || 0;
            const Z_total = Zm + Zother;

            // 2. Calculate dds (Reach Distance) based on Annex I
            let dds = 0;
            const type = document.getElementById('deviceType').value;

            if (type === 'vertical') {
                // Annex I.3.2
                let de = parseFloat(document.getElementById('de').value) || 0;
                
                // Convert de to mm for formula calculation if in inches
                if(currentUnit === 'in') de = de * 25.4;

                let d_reach_through = 0;

                if (de <= 64) {
                    // ddt = 3.4 (de - 7)
                    d_reach_through = 3.4 * (de - 7);
                    if (d_reach_through < 0) d_reach_through = 0;
                } else if (de <= 600) {
                    d_reach_through = 850; 
                } else {
                    d_reach_through = 1200; // Generic fail-safe for huge gaps
                }

                // Convert back to inches if necessary
                if(currentUnit === 'in') d_reach_through = d_reach_through / 25.4;

                // Reach Over check
                let d_reach_over = 0;
                const reachOverSelect = document.getElementById('reachOver');
                const manualReachInput = document.getElementById('manualReachOver');
                const manualDiv = document.getElementById('manualReachOverDiv');

                if (reachOverSelect && reachOverSelect.value === 'yes') {
                    manualDiv.classList.remove('hidden');
                    d_reach_over = parseFloat(manualReachInput.value) || 0;
                } else if(manualDiv) {
                    manualDiv.classList.add('hidden');
                }

                dds = Math.max(d_reach_through, d_reach_over);

            } else if (type === 'horizontal' || type === 'mat') {
                // Annex I.4
                // Fixed at 1200mm / 48"
                dds = (currentUnit === 'mm') ? 1200 : 47.24;

            } else if (type === 'twohand') {
                // Annex I.6
                const shrouded = document.getElementById('shrouded').value;
                if (shrouded === 'yes') {
                    dds = 0;
                } else {
                    dds = (currentUnit === 'mm') ? 550 : 21.65;
                }

            } else if (type === 'single') {
                // Annex I.7
                const actuator = document.getElementById('actuatorType').value;
                if (actuator === 'hand') {
                    dds = (currentUnit === 'mm') ? 2200 : 86.6;
                } else {
                    dds = (currentUnit === 'mm') ? 2500 : 98.5;
                }
            } else if (type === 'interlock') {
                // Manual entry from table E.3
                dds = parseFloat(document.getElementById('manualReachThrough').value) || 0;
            }

            // 3. Final Calculation Equation H.1
            // D = (K * T) + dds + Z
            // Note: K is units/sec, T is sec. Result is units.
            let D = (K * T_total) + dds + Z_total;

            // Minimum distance check for Perpendicular Approach (10.7.1.2)
            // Typically applies to Vertical Light Curtains
            let minD = (currentUnit === 'mm') ? 100 : 4;
            if (type === 'vertical' && D < minD) {
                D = minD; 
            }

            // Display
            document.getElementById('finalResult').innerText = D.toFixed(2) + " " + currentUnit;
            
            // Build explanatory string
            const eqStr = `D = (${K} √ó ${T_total.toFixed(3)}) + ${dds.toFixed(1)} + ${Z_total} = ${D.toFixed(1)} ${currentUnit}`;
            document.getElementById('equationDisplay').innerText = eqStr;
        }

        // --- Helpers ---
        function updateUnits() {
            currentUnit = document.getElementById('units').value;
            const labels = document.querySelectorAll('.unit-dist');
            labels.forEach(l => l.innerText = currentUnit);

            const speedLabel = document.getElementById('unit-speed');
            const kInput = document.getElementById('K');

            if (currentUnit === 'mm') {
                speedLabel.innerText = 'mm/s';
                kInput.value = K_DEFAULT_MM;
            } else {
                speedLabel.innerText = 'in/s';
                kInput.value = K_DEFAULT_IN;
            }
            updateDeviceInputs(); // Reset device specific defaults
            calculateSafetyDistance();
        }

        function togglePanel() {
            const panel = document.getElementById('sidePanel');
            panel.classList.toggle('open');
        }
    </script>
</body>
</html>